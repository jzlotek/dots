#!/usr/bin/env bash
#      _ _____  ____        _
#     | |__  / |  _ \  ___ | |_ ___
#  _  | | / /  | | | |/ _ \| __/ __|
# | |_| |/ /_  | |_| | (_) | |_\__ \
#  \___//____| |____/ \___/ \__|___/
#
# Use at your own risk :)
#
# This will overwrite all the files in config and home that
# are in this git repo. While the config management portion of
# this script can be run on most Posix-compliant systems, the
# bootstrapping (-s flag) is only made for Arch Linux (btw)
# with Hyprland as its window manager.
#
# If you wish to use the dots as-is, make sure you have git, rsync
# and curl installed to your system
#
# Built with <3 (and because I have done this too many times)
# - jzlotek

TMPDIR=$(mktemp -d)
DOTS_REPO="${DOTS_REPO:-git@github.com:jzlotek/dots.git}"
CONFIG_DIR="${XDG_CONFIG_DIR:-$HOME/.config}"
INSTALL_DIR="${XDG_DATA_HOME:-$HOME/.local/share}"
CWD=$(pwd)
SYNC="false"
FULL="false"
BOOTSTRAP="false"

function cleanup() {
	rm -r $TMPDIR
}
function restore_cwd() {
	if [ $(pwd) != $CWD ]; then
		cd $CWD
	fi
}
trap cleanup EXIT INT TERM
trap restore_cwd EXIT INT TERM


print_help() {
	cat <<-EOF
	install dotfiles

	By default will only install TUI app configs

	-s requires sudo. sync packages (Arch only right now btw)
	-f full install. Installes configs used for desktop env
	-h print this message and exit
	EOF
}

function check_pkg_installed() {
	if command -v "$1" >/dev/null; then
		printf "\e[32m%s found\n\e[0m" "$1"
	else
		printf "\e[31m%s NOT found\n\e[0m" "$1"
		exit 1
	fi
}

function bootstrap() {
	check_pkg_installed git > /dev/null
	BOOTSTRAP_DIR="${INSTALL_DIR}/dots"
	[ ! -d "${BOOTSTRAP_DIR}/.git" ] && git clone "${DOTS_REPO}" "${BOOTSTRAP_DIR}"
	exec "${BOOTSTRAP_DIR}/install" $(echo "${@}" | sed 's/-b//g')
}

function install_yay() {
	command -v yay >/dev/null && return
	check_pkg_installed git
	pushd "${TMPDIR}" >/dev/null
	git clone https://aur.archlinux.org/yay.git
	pushd yay >/dev/null
	makepkg -si
	popd >/dev/null
	popd >/dev/null
}

function setup_chaotic_aur() {
	sudo pacman-key --recv-key 3056513887B78AEB --keyserver keyserver.ubuntu.com
	sudo pacman-key --lsign-key 3056513887B78AEB
	sudo pacman -U 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst'
	sudo pacman -U 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst'

	if ! grep -q "/etc/pacman.d/chaotic-mirrorlist" "/etc/pacman.conf"; then
		sudo cat >> /etc/pacman.conf <<-EOF
[chaotic-aur]
Include = /etc/pacman.d/chaotic-mirrorlist
EOF
	fi

}

function install_ohmyzsh() {
	ZSH="${CONFIG_DIR}/oh-my-zsh"
	([ ! -d "${ZSH}" ] && sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)")
}

function install_tmux() {
	[ ! -d "${CONFIG_DIR}/tpm/plugins/tpm" ] && git clone https://github.com/tmux-plugins/tpm "${CONFIG_DIR}/tpm/plugins/tpm"
	ln -sf "${CONFIG_DIR}/tmux/tmux.conf" $HOME/.tmux.conf
}

function sync_packages() {
	sudo pacman -Sy
	sudo pacman -S --needed git --noconfirm
	install_yay
	tail packages.csv -n+2 | cut -d , -f 2 | uniq | while read line; do
		repo=""
		[ ! -z "${line}" ] && repo="--repo ${line}"
		packages="$(tail packages.csv -n+2 | grep -E ",${line}$" | cut -d , -f 1 | uniq | tr "\n" " ")"
		[ -z "${packages}" ] && continue
		yay -S --needed --noconfirm >/dev/null $repo $packages
	done
}
function install_dotfiles() {
	stow base nvim tmux scripts -t "${HOME}"

	if [ "${FULL}" = "true" ]; then
		stow wm -t "${HOME}"
		scripts/.local/bin/setbg wm/.config/hypr/wallpaper.png
	fi
}

orig_args=$@

while getopts "shfb" opt; do
	case $opt in
		s)
			SYNC="true"
			;;
		b)
			BOOTSTRAP="true"
			;;
		f)
			FULL="true"
			;;
		h)
			print_help
			exit 0
			;;
		*)
			exit 1
			;;
	esac
done


[ "${BOOTSTRAP}" = "true" ] && bootstrap $orig_args
[ $SYNC = "true" ] && sync_packages

check_pkg_installed git
check_pkg_installed curl
check_pkg_installed stow

install_ohmyzsh
install_tmux
install_dotfiles
